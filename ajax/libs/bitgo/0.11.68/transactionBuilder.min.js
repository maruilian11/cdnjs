var Q=require("q"),Address=require("bitcoinjs-lib/src/address"),HDNode=require("./hdnode"),ECKey=require("bitcoinjs-lib/src/eckey"),Transaction=require("bitcoinjs-lib/src/transaction"),_TransactionBuilder=require("bitcoinjs-lib/src/transaction_builder"),Script=require("bitcoinjs-lib/src/script"),Scripts=require("bitcoinjs-lib/src/scripts"),ECPubkey=require("bitcoinjs-lib/src/ecpubkey"),ECSignature=require("bitcoinjs-lib/src/ecsignature"),Opcodes=require("bitcoinjs-lib/src/opcodes"),networks=require("bitcoinjs-lib/src/networks"),common=require("./common"),Util=require("./util"),_=require("lodash"),MAX_FEE=1e7,MAX_FEE_RATE=1e5,MIN_FEE_RATE=1e8*1e-5,FEE_PER_KB=1e4,MINIMUM_BTC_DUST=5460,MIN_SPLIT_AMOUNT=1e6,FALLBACK_DEFAULT_UNSPENTS_TARGET=8;exports.createTransaction=function(e){var n=e.minConfirms||0,t=void 0===e.validate?!0:e.validate,r=[];if("object"!=typeof e.wallet||e.fee&&"number"!=typeof e.fee||e.feeRate&&"number"!=typeof e.feeRate||"number"!=typeof n||e.forceChangeAtEnd&&"boolean"!=typeof e.forceChangeAtEnd||e.changeAddress&&"string"!=typeof e.changeAddress||void 0!==e.splitChangeSize&&"number"!=typeof e.splitChangeSize||void 0!==e.minUnspentsTarget&&"number"!=typeof e.minUnspentsTarget||t&&"boolean"!=typeof t||e.enforceMinConfirmsForChange&&"boolean"!=typeof e.enforceMinConfirmsForChange||e.minUnspentSize&&"number"!=typeof e.minUnspentSize||e.maxFeeRate&&"number"!=typeof e.maxFeeRate||e.unspents&&e.unspents.length<1||e.feeTxConfirmTarget&&"number"!=typeof e.feeTxConfirmTarget||e.instant&&"boolean"!=typeof e.instant||e.instantFee&&"object"!=typeof e.instantFee)throw new Error("invalid argument");var i,a=0;if(e.feeSingleKeySourceAddress)try{Address.fromBase58Check(e.feeSingleKeySourceAddress),i=e.feeSingleKeySourceAddress}catch(s){throw new Error("invalid bitcoin address: "+e.feeSingleKeySourceAddress)}if(e.feeSingleKeyWIF){var o;try{o=ECKey.fromWIF(e.feeSingleKeyWIF)}catch(s){throw new Error("Failed to parse key when importing feeSingleKeyWIF")}if(i=o.pub.getAddress(networks[common.getNetwork()]).toString(),e.feeSingleKeySourceAddress&&e.feeSingleKeySourceAddress!==i)throw new Error("feeSingleKeySourceAddress did not correspond to address of feeSingleKeyWIF")}if("undefined"!=typeof e.minUnspentsTarget){if(e.splitChangeSize)throw new Error("cannot specify both splitChangeSize as well as target number of unspents");if(e.unspents)throw new Error("cannot specify both minUnspentsTarget as well as custom unspents");if(e.minUnspentsTarget>50)throw new Error("cannot target more than 50 unspents - use wallet.fanOutUnspents instead")}else"undefined"==typeof e.splitChangeSize&&(e.splitChangeSize=-1);if("object"!=typeof e.recipients)throw new Error("recipients must be array of { address: abc, amount: 100000 } objects");var u=("undefined"!=typeof e.fee)+("undefined"!=typeof e.feeRate)+("undefined"!=typeof e.feeTxConfirmTarget);if(u>1)throw new Error("cannot specify more than one of fee, feeRate and feeTxConfirmTarget");if(0===u&&(e.feeTxConfirmTarget=2),"undefined"==typeof e.maxFeeRate&&(e.maxFeeRate=MAX_FEE_RATE),e.recipients instanceof Array?r=e.recipients:(r=[],Object.keys(e.recipients).forEach(function(n){var t=e.recipients[n];r.push({address:n,amount:t})})),0===r.length)throw new Error("must have at least one recipient");var f=e.fee,c=e.feeRate,d="undefined"==typeof f;if(f>MAX_FEE)throw new Error("fee too generous");if(c>MAX_FEE_RATE)throw new Error("fee rate too generous");var h=0;r.forEach(function(e){if("string"==typeof e.address){var n;try{n=Address.fromBase58Check(e.address)}catch(t){throw new Error("invalid bitcoin address: "+e.address)}if(e.script&&n.toOutputScript().toHex()!=e.script)throw new Error("both script and address provided but they did not match: "+e.address+" "+e.script)}if("number"!=typeof e.amount||isNaN(e.amount)||e.amount<0)throw new Error("invalid amount for "+e.address+": "+e.amount);h+=e.amount});var p=e.instantFee;if(p&&("number"!=typeof p.amount||"string"!=typeof p.address))throw new Error("invalid instantFee");var l,g,m=h+(f||0),v=[],w=new Transaction,y=function(){return Q().then(function(){return e.instant&&!p?e.wallet.bitgo.instantFee({amount:h,wallet:e.wallet.id()}).then(function(e){e&&e.fee>0&&(p={amount:e.fee})}):void 0}).then(function(){p&&p.amount>0&&(m+=p.amount)})},E=function(){return p&&!p.address?e.wallet.bitgo.instantFeeAddress().then(function(e){p.address=e.address}):void 0},b=1,S=0,T=function(){return e.feeTxConfirmTarget?e.wallet.estimateFee({numBlocks:e.feeTxConfirmTarget,maxFee:e.maxFeeRate}).then(function(n){var t=n.feePerKb;c=MIN_FEE_RATE>t?MIN_FEE_RATE:t>e.maxFeeRate?e.maxFeeRate:t})["catch"](function(){c=FEE_PER_KB}):Q()},A=function(){if(e.unspents)return void(l=e.unspents);var t={target:m+1e6,minSize:e.minUnspentSize||MINIMUM_BTC_DUST,instant:e.instant};return e.wallet.unspentsPaged(t).then(function(t){l=t.unspents.filter(function(t){var r=t.confirmations||0;return!e.enforceMinConfirmsForChange&&t.isChange?!0:r>=n}),S=t.total-t.count,e.minUnspentsTarget&&(b=Math.max(e.minUnspentsTarget-S,1))})},F=[],C=function(){if(i){var n=1e6;return e.instant&&(n+=.001*m),e.wallet.bitgo.get(e.wallet.bitgo.url("/address/"+i+"/unspents?target="+n)).then(function(e){if(e.body.total<=0)throw new Error("No unspents available in single key fee source");F=e.body.unspents})}},x=function(){var e=2,n=34*(r.length+1+(p?1:0)+(i?1:0))/1e3,t=w.ins.length*e*170/1e3;return t+n},k=function(){var e="undefined"!=typeof c?c:FEE_PER_KB;return Math.ceil(x()*e)},I=[],M=function(){if(g=0,l.every(function(e){g+=e.value;var n=new Buffer(e.tx_hash,"hex");n=new Buffer(Array.prototype.reverse.call(n));var t=Script.fromHex(e.script);return w.addInput(n,e.tx_output_n,4294967295,t),(i?h:m)>g}),i&&(a=0,I=[],F.every(function(e){return a+=e.value,g+=e.value,w.addInput(e.tx_hash,e.tx_output_n),I.push(e),a<f+(p?p.amount:0)})),d){var e=k(),n="undefined"==typeof f||e>f;if(f=e,m=f+h,p&&(m+=p.amount),n)return g=0,w.ins=[],M()}var t=f+(p?p.amount:0);if(i&&t>_.sum(F,"value")){var r=new Error("Insufficient fee amount available in single key fee source");return r.result={fee:f,available:g,instantFee:p},Q.reject(r)}if((i?h:m)>g){var r=new Error("Insufficient funds");return r.result={fee:f,available:g,instantFee:p},Q.reject(r)}},K=function(){var n=x();if(n>=90)throw new Error("transaction too large: estimated size "+n+"kb");var s=[];r.forEach(function(e){var n;if("string"==typeof e.address){var t=Address.fromBase58Check(e.address);n=t.toOutputScript()}else{if("object"!=typeof e.script)throw new Error("neither recipient address nor script was provided");n=e.script}s.push({script:n,amount:e.amount})});var o=function(){return"number"!=typeof e.splitChangeSize?0:e.splitChangeSize>=0?e.splitChangeSize:e.wallet.stats().then(function(n){var t=Math.max(e.wallet.balance()/100,1e7),r=25,i=75;return n.nSends>=r&&n.sendSizes&&n.sendSizes[i]?Math.floor(Math.max(n.sendSizes[i],t)):0})["catch"](function(e){return console.log(e),0})},u=function(n){if(0>n)throw new Error("negative change amount");if(MINIMUM_BTC_DUST>n)return[];var r=[];if(i){var s=a-(f+(p?p.amount:0));s>=MINIMUM_BTC_DUST&&(r.push({address:i,amount:s}),n-=s)}if(e.changeAddress)return r.push({address:e.changeAddress,amount:n}),r;if("safe"===e.wallet.type())return e.wallet.addresses().then(function(e){return r.push({address:e.addresses[0].address,amount:n}),r});var u,c=b-1,d=function(){if(!(r.length>=c)){var i=n/(b-r.length),a=(2*Math.random()-1)/6*i;if(i=1e4*Math.floor((i+a)/1e4),!(MIN_SPLIT_AMOUNT>=i))return e.wallet.createAddress({chain:1,validate:t}).then(function(e){return n-=i,e.amount=i,r.push(e),d()})}};return Q().then(function(){return e.minUnspentsTarget?d():e.splitChangeSize?Q().then(o).then(function(i){if(!(i>0))return b=Math.max(FALLBACK_DEFAULT_UNSPENTS_TARGET-S,1),c=b-1,d();if(n>2*i){u=n/2;var a=(2*Math.random()-1)/6*n;return u=1e4*Math.floor((u+a)/1e4),n-=u,e.wallet.createAddress({chain:1,validate:t}).then(function(e){e.amount=u,r.push(e)})}}):void 0}).then(function(){return e.wallet.createAddress({chain:1,validate:t})}).then(function(e){return e.amount=n,r.push(e),r})};return Q().then(function(){return u(g-m)}).then(function(n){v=n;var t=v.concat([]);p&&p.amount>0&&t.push(p),t.forEach(function(n){n.script=Address.fromBase58Check(n.address).toOutputScript();var t=e.forceChangeAtEnd?s.length:_.random(0,s.length);s.splice(t,0,n)}),s.forEach(function(e){w.addOutput(e.script,e.amount)})})},U=function(){var n=_.map(l,function(e){return _.pick(e,["chainPath","redeemScript","instant"])}),t=_.slice(n,0,w.ins.length-I.length);_.every(I,function(e){t.push({redeemScript:!1,chainPath:!1})});var r={transactionHex:w.toBuffer().toString("hex"),unspents:t,fee:f,changeAddresses:v.map(function(e){return _.pick(e,["address","path","amount"])}),walletId:e.wallet.id(),walletKeychains:e.wallet.keychains,feeRate:c,instant:e.instant,instantFee:p};return r};return Q().then(function(){return y()}).then(function(){return Q.all([E(),T(),A(),C()])}).then(M).then(K).then(U)},exports.signTransaction=function(e){var n,t=e.keychain,r=void 0===e.validate?!0:e.validate;if("string"!=typeof e.transactionHex)throw new Error("expecting the transaction hex as a string");if(!Array.isArray(e.unspents))throw new Error("expecting the unspents array");if("boolean"!=typeof r)throw new Error("expecting validate to be a boolean");if("object"!=typeof t||"string"!=typeof t.xprv){if("string"!=typeof e.signingKey)throw new Error("expecting the keychain object with xprv");n=ECKey.fromWIF(e.signingKey),t=void 0}var i;e.feeSingleKeyWIF&&(i=ECKey.fromWIF(e.feeSingleKeyWIF));var a=Transaction.fromHex(e.transactionHex);if(a.ins.length!==e.unspents.length)throw new Error("length of unspents array should equal to the number of transaction inputs");var s;t&&(s=HDNode.fromBase58(t.xprv));for(var o=0;o<a.ins.length;++o)if(e.unspents[o].redeemScript!==!1){if(t){var u=t.walletSubPath||"/0/0",f=t.path+u+e.unspents[o].chainPath,c=s.deriveFromPath(f);n=c.privKey}var d=Script.fromHex(e.unspents[o].redeemScript),h=_TransactionBuilder.fromTransaction(a);try{h.sign(o,n,d,Transaction.SIGHASH_ALL)}catch(p){return Q.reject("Failed to sign input #"+o)}a=h.buildIncomplete();var l=a.ins[o].script.chunks;if(5!==l.length)throw new Error("unexpected number of chunks in the OP_CHECKMULTISIG script after signing");if(l[1]?l.splice(2,1):l[2]&&l.splice(1,1),a.ins[o].script=Script.fromChunks(l),r&&-1!==exports.verifyInputSignatures(a,o,d))throw new Error("number of signatures is invalid - something went wrong when signing")}else{if(!i)throw new Error("single key address used in input but feeSingleKeyWIF not provided");var h=_TransactionBuilder.fromTransaction(a);h.sign(o,i),a=h.buildIncomplete()}return Q.when({transactionHex:a.toBuffer().toString("hex")})},exports.verifyInputSignatures=function(e,n,t){if(0>n||n>=e.ins.length)throw new Error("illegal index");if(!(t instanceof Script))throw new Error("illegal argument");var r=e.ins[n].script,i=1,a=[],s=[];switch(Scripts.classifyInput(r,!0)){case"scripthash":var o=r.chunks[r.chunks.length-1];t=Script.fromBuffer(o),i=t.chunks[0]-Opcodes.OP_1+1;for(var u=1;u<r.chunks.length-1;++u)a.push(r.chunks[u]);for(var u=1;u<t.chunks.length-2;++u)s.push(t.chunks[u]);break;case"pubkeyhash":i=1,a.push(r.chunks[0]),s.push(r.chunks[1]);break;default:return 0}for(var f=0,c=0;c<a.length;++c)if(a[c]!=Opcodes.OP_0){var d=a[c][a[c].length-1];a[c]=a[c].slice(0,a[c].length-1);for(var h=e.hashForSignature(n,t,d),p=ECSignature.fromDER(a[c]),l=!1,g=0;g<s.length;++g){var m=ECPubkey.fromBuffer(s[g]);if(l=m.verify(h,p)){s.splice(g,1);break}}if(!l)throw new Error("invalid signature");f++}return i>f&&(f=-f),f};