var express=require("express"),httpProxy=require("http-proxy"),url=require("url"),morgan=require("morgan"),fs=require("fs"),path=require("path"),common=require("./common"),pjson=require("../package.json"),BITGOEXPRESS_USER_AGENT="BitGoExpress/"+pjson.version;module.exports=function(e){var r=express();if(e.logfile){var o=path.resolve(e.logfile),n=fs.createWriteStream(o,{flags:"a"});console.log("Log location: "+o),r.use(morgan("combined",{stream:n}))}else r.use(morgan("combined"));morgan.token("remote-user",function(e,r){return e.isProxy?"proxy":"local_express"}),r.use(function(e,r,o){e.url=e.url.replace(/\/\//g,"/"),o()}),require("./clientRoutes")(r,e);var t={};"testnet"===common.Environments[e.env].network&&(t={secure:!1}),(e.customrooturi||e.custombitcoinnetwork||process.env.BITGO_CUSTOM_ROOT_URI||process.env.BITGO_CUSTOM_BITCOIN_NETWORK)&&(e.env="custom",e.customrooturi&&(common.Environments.custom.uri=e.customrooturi),e.custombitcoinnetwork&&(common.Environments.custom.network=e.custombitcoinnetwork));var s=httpProxy.createProxyServer(t);return s.on("proxyReq",function(r,o,n,t){r.setHeader("host",url.parse(common.Environments[e.env].uri).hostname);var s=o.headers["user-agent"]?BITGOEXPRESS_USER_AGENT+" "+o.headers["user-agent"]:BITGOEXPRESS_USER_AGENT;r.setHeader("User-Agent",s)}),r.use(function(r,o){r.isProxy=!0,s.web(r,o,{target:common.Environments[e.env].uri,changeOrigin:!0})}),r};