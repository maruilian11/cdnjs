var superagent=require("superagent"),bitcoin=require("bitcoinjs-lib"),Address=bitcoin.Address,Blockchain=require("./blockchain"),Keychains=require("./keychains"),Wallet=require("./wallet"),Wallets=require("./wallets"),Markets=require("./markets"),PendingApprovals=require("./pendingapprovals"),sjcl=require("./sjcl.min"),common=require("./common"),ECKey=bitcoin.ECKey,ECPubkey=bitcoin.ECPubKey,networks=bitcoin.networks,Util=require("./util"),Q=require("q"),pjson=require("../package.json"),_=require("lodash");process.browser||require("superagent-proxy")(superagent);var _end=superagent.Request.prototype.end;superagent.Request.prototype.end=function(){var e=this;return new Q.Promise(function(t,r){var n;try{return _end.call(e,function(e,n){return e?r(e):t(n)})}catch(o){return n=o,r(n)}})},superagent.Request.prototype.then=function(){var e;return(e=this.end()).then.apply(e,arguments)},superagent.Request.prototype["catch"]=function(){var e;return(e=this.end())["catch"].apply(e,arguments)},superagent.Request.prototype.result=function(e){var t=function(e){var t=new Error(e.body.error?e.body.error:e.status.toString());return t.status=e.status,_.has(e.headers,"x-auth-required")&&"true"===e.headers["x-auth-required"]&&(t.invalidToken=!0),e.body.needsOTP&&(t.needsOTP=!0),t};return this.then(function(r){if("number"==typeof r.status&&r.status>=200&&r.status<300)return e?r.body[e]:r.body;throw t(r)},function(e){if(e.response)throw t(e.response);throw e})};var testNetWarningMessage=!1,BitGo=function(e){if(e=e||{},!common.validateParams(e,[],["clientId","clientSecret","refreshToken","accessToken","userAgent","customRootURI","customBitcoinNetwork"])||e.useProduction&&"boolean"!=typeof e.useProduction)throw new Error("invalid argument");if(!e.clientId!=!e.clientSecret)throw new Error("invalid argument - must provide both client id and secret");if(e.useProduction){if(e.env&&"prod"!==e.env)throw new Error("Cannot set test environment and use production");e.env="prod"}if("production"===e.env&&(e.env="prod"),(e.customRootURI||e.customBitcoinNetwork||e.customSigningAddress||process.env.BITGO_CUSTOM_ROOT_URI||process.env.BITGO_CUSTOM_BITCOIN_NETWORK)&&(e.env="custom",e.customRootURI&&(common.Environments.custom.uri=e.customRootURI),e.customBitcoinNetwork&&(common.Environments.custom.network=e.customBitcoinNetwork),e.customSigningAddress&&(common.Environments.custom.customSigningAddress=e.customSigningAddress)),e.env){if(!common.Environments[e.env])throw new Error("invalid environment");this._baseUrl=common.Environments[e.env].uri}else e.env=process.env.BITGO_ENV||"test",testNetWarningMessage||"test"!==e.env||(testNetWarningMessage=!0,console.log("BitGo SDK env not set - defaulting to testnet at test.bitgo.com."));this.env=e.env,common.setNetwork(common.Environments[e.env].network),this._baseUrl||(this._baseUrl=common.Environments[e.env].uri),this._baseApiUrl=this._baseUrl+"/api/v1",this._user=null,this._keychains=null,this._wallets=null,this._clientId=e.clientId,this._clientSecret=e.clientSecret,this._token=e.accessToken||null,this._refreshToken=e.refreshToken||null,this._userAgent=e.userAgent||"BitGoJS/"+this.version(),this._validate=void 0===e.validate?!0:e.validate,this.request={};var t=["get","post","put","del"];if(!e.proxy&&process.env.BITGO_USE_PROXY&&(e.proxy=process.env.BITGO_USE_PROXY),process.browser&&e.proxy)throw new Error("cannot use https proxy params while in browser");var r=function(t){return function(){var r=superagent[t].apply(null,arguments);return e.proxy&&(r=r.proxy(e.proxy)),o._token&&r.set("Authorization","Bearer "+o._token),process.browser||r.set("User-Agent",o._userAgent),r}};for(var n in t){var o=this,s=t[n];o[s]=r(s)}};BitGo.prototype.getValidate=function(){return this._validate},BitGo.prototype.setValidate=function(e){if("boolean"!=typeof e)throw new Error("invalid argument");this._validate=e},BitGo.prototype.getEnv=function(){return this.env},BitGo.prototype.clear=function(){this._user=this._token=this._refreshToken=void 0},BitGo.prototype.reject=function(e,t){return Q().thenReject(new Error(e)).nodeify(t)},BitGo.prototype.version=function(){return pjson.version},BitGo.prototype.toJSON=function(){return{user:this._user,token:this._token,extensionKey:this._extensionKey?this._extensionKey.toWIF():null}},BitGo.prototype.fromJSON=function(e){this._user=e.user,this._token=e.token,e.extensionKey&&(this._extensionKey=ECKey.fromWIF(e.extensionKey))},BitGo.prototype.user=function(){return this._user},BitGo.prototype.verifyAddress=function(e){e=e||{},common.validateParams(e,["address"],[]);var t;try{t=Address.fromBase58Check(e.address)}catch(r){return!1}var n=common.getNetwork();return t.version===networks[n].pubKeyHash||t.version===networks[n].scriptHash},BitGo.prototype.verifyPassword=function(e,t){if(e=e||{},common.validateParams(e,["password"],[]),!this._user||!this._user.username)throw new Error("no current user");var r=sjcl.codec.utf8String.toBits(this._user.username),n=new sjcl.misc.hmac(r,sjcl.hash.sha256),o=sjcl.codec.hex.fromBits(n.encrypt(e.password));return this.post(this.url("/user/verifypassword")).send({password:o}).result("valid").nodeify(t)},BitGo.prototype.encrypt=function(e){e=e||{},common.validateParams(e,["input","password"],[]);var t={iter:1e4,ks:256};return sjcl.encrypt(e.password,e.input,t)},BitGo.prototype.decrypt=function(e){return e=e||{},common.validateParams(e,["input","password"],[]),sjcl.decrypt(e.password,e.input)},BitGo.prototype.getECDHSecret=function(e){if(e=e||{},common.validateParams(e,["otherPubKeyHex"],[]),"object"!=typeof e.eckey)throw new Error("eckey object required");var t=ECPubkey.fromHex(e.otherPubKeyHex),r=t.Q.multiply(e.eckey.d),n=Util.bnToByteArrayUnsigned(r.affineX);return new Buffer(n).toString("hex")},BitGo.prototype.getECDHSharingKeychain=function(e,t){e=e||{},common.validateParams(e,[],[]);var r=this;return this.get(this.url("/user/settings")).result().then(function(e){return e.settings.ecdhKeychain?r.keychains().get({xpub:e.settings.ecdhKeychain}):r.reject("ecdh keychain not found for user",t)}).nodeify(t)},BitGo.prototype.markets=function(){return this._markets||(this._markets=new Markets(this)),this._markets},BitGo.prototype.market=function(e,t){return e=e||{},common.validateParams(e,[],[],t),this.get(this.url("/market/latest")).result().nodeify(t)},BitGo.prototype.yesterday=function(e,t){return e=e||{},common.validateParams(e,[],[],t),this.get(this.url("/market/yesterday")).result().nodeify(t)},BitGo.prototype.authenticateWithAccessToken=function(e,t){e=e||{},common.validateParams(e,["accessToken"],[],t),this._token=e.accessToken},BitGo.prototype.authenticate=function(e,t){e=e||{},common.validateParams(e,["username","password"],["otp"],t);var r=e.username,n=e.password,o=e.otp,s=e.trust,i=sjcl.codec.utf8String.toBits(r),a=new sjcl.misc.hmac(i,sjcl.hash.sha256),u=sjcl.codec.hex.fromBits(a.encrypt(n)),c={email:r,password:u,forceSMS:!!e.forceSMS};o&&(c.otp=o,s&&(c.trust=1)),e.extensible&&(this._extensionKey=ECKey.makeRandom(),c.extensible=!0,c.extensionAddress=this._extensionKey.pub.getAddress().toString());var h=this;return this._token?this.reject("already logged in",t):this.post(this.url("/user/login")).send(c).result().then(function(e){return h._user=e.user,h._token=e.access_token,e}).nodeify(t)},BitGo.prototype.registerPushToken=function(e,t){if(e=e||{},common.validateParams(e,["pushToken","operatingSystem"],[],t),!this._token)return this.reject("not logged in",t);var r=_.pick(e,["pushToken","operatingSystem"]);return this.post(this.url("/devices")).send(r).result().nodeify(t)},BitGo.prototype.verifyPushToken=function(e,t){if(e=e||{},common.validateParams(e,["pushVerificationToken"],[],t),!this._token)return this.reject("not logged in",t);var r=_.pick(e,"pushVerificationToken");return this.post(this.url("/devices/verify")).send(r).result().nodeify(t)},BitGo.prototype.authenticateWithAuthCode=function(e,t){if(e=e||{},common.validateParams(e,["authCode"],[],t),!this._clientId||!this._clientSecret)throw new Error("Need client id and secret set first to use this");var r=e.authCode,n=this;if(this._token)return this.reject("already logged in",t);var o;return this.post(this._baseUrl+"/oauth/token").send({grant_type:"authorization_code",code:r,client_id:n._clientId,client_secret:n._clientSecret}).result().then(function(e){return o=e,n._token=e.access_token,n._refreshToken=e.refresh_token,n.me()}).then(function(e){return n._user=e,o}).nodeify(t)},BitGo.prototype.refreshToken=function(e,t){e=e||{},common.validateParams(e,[],["refreshToken"],t);var r=e.refreshToken||this._refreshToken;if(!r)throw new Error("Must provide refresh token or have authenticated with Oauth before");if(!this._clientId||!this._clientSecret)throw new Error("Need client id and secret set first to use this");var n=this;return this.post(this._baseUrl+"/oauth/token").send({grant_type:"refresh_token",refresh_token:r,client_id:n._clientId,client_secret:n._clientSecret}).result().then(function(e){return n._token=e.access_token,n._refreshToken=e.refresh_token,e}).nodeify(t)},BitGo.prototype.logout=function(e,t){e=e||{},common.validateParams(e,[],[],t);var r=this;return this.get(this.url("/user/logout")).result().then(function(){r.clear()}).nodeify(t)},BitGo.prototype.getUser=function(e,t){return e=e||{},common.validateParams(e,["id"],[],t),this.get(this.url("/user/"+e.id)).result("user").nodeify(t)},BitGo.prototype.me=function(e,t){return this.getUser({id:"me"},t)},BitGo.prototype.unlock=function(e,t){return e=e||{},common.validateParams(e,[],["otp"],t),this.post(this.url("/user/unlock")).send(e).result().nodeify(t)},BitGo.prototype.lock=function(e,t){return e=e||{},common.validateParams(e,[],[],t),this.post(this.url("/user/lock")).result().nodeify(t)},BitGo.prototype.session=function(e,t){return e=e||{},common.validateParams(e,[],[],t),this.get(this.url("/user/session")).result("session").nodeify(t)},BitGo.prototype.sendOTP=function(e,t){return e=e||{},common.validateParams(e,[],[],t),this.post(this.url("/user/sendotp")).send(e).result().nodeify(t)},BitGo.prototype.extendToken=function(e,t){e=e||{},common.validateParams(e,[],[],t);var r=Date.now(),n=e.duration,o=r+"|"+this._token+"|"+n,s=common.getNetwork(),i=bitcoin.Message.sign(this._extensionKey,o,networks[s]).toString("hex");return this.post(this.url("/user/extendtoken")).send(e).set("timestamp",r).set("signature",i).result().nodeify(t)},BitGo.prototype.getSharingKey=function(e,t){return e=e||{},common.validateParams(e,["email"],[],t),this.post(this.url("/user/sharingkey")).send(e).result().nodeify(t)},BitGo.prototype.ping=function(e,t){return e=e||{},common.validateParams(e,[],[],t),this.get(this.url("/ping")).result().nodeify(t)},BitGo.prototype.blockchain=function(){return this._blockchain||(this._blockchain=new Blockchain(this)),this._blockchain},BitGo.prototype.keychains=function(){return this._keychains||(this._keychains=new Keychains(this)),this._keychains},BitGo.prototype.wallets=function(){return this._wallets||(this._wallets=new Wallets(this)),this._wallets},BitGo.prototype.pendingApprovals=function(){return this._pendingApprovals||(this._pendingApprovals=new PendingApprovals(this)),this._pendingApprovals},BitGo.prototype.newWalletObject=function(e){return new Wallet(this,e)},BitGo.prototype.url=function(e){return this._baseApiUrl+e},BitGo.prototype.labels=function(e,t){return e=e||{},common.validateParams(e,[],[],t),this.get(this.url("/labels")).result("labels").nodeify(t)},BitGo.prototype.estimateFee=function(e,t){e=e||{},common.validateParams(e,[],[],t);var r={};if(e.numBlocks){if("number"!=typeof e.numBlocks)throw new Error("invalid argument");r.numBlocks=e.numBlocks}if(e.maxFee){if("number"!=typeof e.maxFee)throw new Error("invalid argument");r.maxFee=e.maxFee}return this.get(this.url("/tx/fee")).query(r).result().nodeify(t)},BitGo.prototype.instantGuarantee=function(e,t){e=e||{},common.validateParams(e,["id"],[],t);var r=this;return this.get(this.url("/instant/"+e.id)).result().then(function(e){if(!e.guarantee)throw new Error("no guarantee found in response body");if(!e.signature)throw new Error("no signature found in guarantee response body");var t=common.Environments[r.env].signingAddress,n=common.getNetwork();if(!bitcoin.Message.verify(t,new Buffer(e.signature,"hex"),e.guarantee,networks[n]))throw new Error("incorrect signature");return e}).nodeify(t)},BitGo.prototype.instantFee=function(e,t){if(e=e||{},common.validateParams(e,[],["wallet"],t),"number"!=typeof e.amount)throw new Error("invalid amount argument");return this.get(this.url("/instant/fee")).query(e).result().nodeify(t)},BitGo.prototype.instantFeeAddress=function(e,t){e=e||{},common.validateParams(e,[],[],t);return this.post(this.url("/instant/feeaddress")).send({}).result().nodeify(t)},module.exports=BitGo;